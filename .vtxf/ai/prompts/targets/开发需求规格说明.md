# mcps-proxy - 开发需求规格说明

## 文档信息

- **项目名称**: mcps-proxy
- **文档版本**: 1.0
- **创建日期**: 2025-10-19
- **文档类型**: 开发需求规格说明

## 项目概述

### 产品定位
mcps-proxy 应设计为一个简洁的MCP（Model Context Protocol）服务器代理工具，能够将多个独立的MCP服务器合并成一个统一的HTTP MCP服务器，提供一个统一的接口来访问所有后端服务器的功能。

### 核心价值
- **统一接口**: 为多个MCP服务器提供单一访问入口
- **协议转换**: 将MCP协议转换为HTTP API
- **配置管理**: 支持灵活的多环境配置
- **开发友好**: 降低MCP服务器集成复杂度

## MCP协议分析

### 核心功能
MCP协议基于JSON-RPC 2.0，主要支持以下功能：
- **工具调用(Tools)**: 服务器暴露可调用的工具函数
- **资源访问(Resources)**: 提供对文件、数据等资源的访问
- **提示(Prompts)**: 预定义的提示模板

### 通信方式
- **stdio**: 通过标准输入输出进行通信
- **HTTP**: 通过HTTP协议进行通信

## 功能需求

### FR-001: 多服务器连接管理
**需求描述**: 系统应支持同时连接和管理多个不同类型的MCP服务器

**具体要求**:
- 支持 stdio 类型的MCP服务器连接
- 支持 HTTP 类型的MCP服务器连接
- 支持 SSE 类型的MCP服务器连接
- 提供基础的连接状态管理
- 实现连接错误检测和处理

**验收标准**:
- [ ] 能够建立并维护stdio连接
- [ ] 能够建立并维护HTTP连接
- [ ] 能够建立并维护SSE连接
- [ ] 连接失败时能够记录错误信息
- [ ] 能够检测连接状态变化

### FR-002: 工具接口聚合
**需求描述**: 系统应将多个MCP服务器的工具合并为统一的接口

**具体要求**:
- 合并所有已连接服务器的工具列表
- 处理工具名称冲突（添加服务器前缀）
- 提供统一的工具调用接口
- 实现标准化的错误响应格式
- 支持工具调用参数传递

**工具命名规则**:
- 所有工具都采用"服务器ID-工具名"格式命名
- 服务器ID来自配置文件中的mcpServers键名
- 例如：filesystem服务器的read_file工具命名为"filesystem-read_file"
- 统一命名规则确保工具名称的一致性和可读性

**验收标准**:
- [ ] 能够获取所有服务器的工具列表
- [ ] 所有工具都能按"服务器ID-工具名"格式正确命名
- [ ] 工具调用能够正确路由到对应服务器
- [ ] 错误响应符合统一格式
- [ ] 参数能够正确传递给目标服务器
- [ ] 命名后的工具名称保持一致性和可读性

### FR-003: HTTP API服务
**需求描述**: 系统应提供HTTP API接口供客户端访问

**具体要求**:
- 实现RESTful API设计
- 支持CORS跨域访问
- 提供JSON-RPC 2.0协议兼容接口
- 支持多种HTTP客户端访问
- 实现请求和响应日志记录
- 默认服务端口为3095，支持自定义端口

**验收标准**:
- [ ] API端点符合RESTful设计原则
- [ ] 跨域请求能够正常处理
- [ ] JSON-RPC 2.0协议完全兼容
- [ ] 支持Web、脚本、MCP客户端等多种访问方式
- [ ] 所有API调用都有日志记录

### FR-004: 配置管理系统
**需求描述**: 系统应提供灵活的配置管理功能

**具体要求**:
- 支持JSON格式配置文件
- 支持多schemas配置（所有schema同时激活）
- 配置文件位置：`~/.mcps-proxy/config.json`
- 实现schema级别的配置隔离
- 支持环境变量替换功能
- 首次运行时自动创建默认配置
- 支持schema级别的启用/禁用控制

**验收标准**:
- [ ] 配置文件格式正确且可解析
- [ ] 多个schema能够同时加载和激活
- [ ] 配置文件位置符合要求
- [ ] schema之间配置相互独立
- [ ] 环境变量能够正确替换
- [ ] 首次运行能自动创建默认配置
- [ ] schema的enabled属性能够正确控制启用/禁用状态
- [ ] 禁用的schema在API调用时返回适当的错误响应

### FR-005: 资源访问代理
**需求描述**: 系统应代理MCP服务器的资源访问功能

**具体要求**:
- 支持资源列表查询
- 支持资源内容读取
- 实现资源访问权限控制
- 处理资源不存在的错误情况

**验收标准**:
- [ ] 能够获取所有服务器的资源列表
- [ ] 能够读取指定资源的内容
- [ ] 资源访问有适当的权限检查
- [ ] 资源不存在时返回明确错误信息

### FR-006: 提示模板代理
**需求描述**: 系统应代理MCP服务器的提示模板功能

**具体要求**:
- 支持提示列表查询
- 支持提示内容获取
- 支持提示参数传递
- 处理提示不存在的错误情况

**验收标准**:
- [ ] 能够获取所有服务器的提示列表
- [ ] 能够获取指定提示的内容
- [ ] 提示参数能够正确传递
- [ ] 提示不存在时返回明确错误信息

## 非功能性需求

### NFR-001: 性能需求
**需求描述**: 系统应满足预期的性能指标

**具体要求**:
- HTTP API响应时间应在2秒内
- 支持至少10个并发MCP服务器连接
- 支持至少100个并发HTTP请求
- 内存使用不超过512MB
- CPU使用率在正常负载下不超过50%

**验收标准**:
- [ ] API响应时间测试通过
- [ ] 并发连接测试通过
- [ ] 并发请求测试通过
- [ ] 内存使用测试通过
- [ ] CPU使用率测试通过

### NFR-002: 可靠性需求
**需求描述**: 系统应具备良好的稳定性和容错能力

**具体要求**:
- 系统应能够7×24小时稳定运行
- 单个MCP服务器连接失败不应影响整体服务
- 具备自动重连机制
- 异常情况下能够优雅降级
- 关键操作应有事务保护

**验收标准**:
- [ ] 长时间运行稳定性测试通过
- [ ] 单点故障不影响整体服务
- [ ] 自动重连功能正常工作
- [ ] 异常情况下系统能够优雅处理
- [ ] 关键操作的事务保护机制有效

### NFR-003: 安全需求
**需求描述**: 系统应具备基本的安全防护能力

**具体要求**:
- 配置文件中的敏感信息应支持环境变量替换
- 支持API访问权限控制
- 实现请求大小限制
- 记录安全相关日志
- 支持HTTPS访问（通过反向代理）

**验收标准**:
- [ ] 敏感信息通过环境变量安全存储
- [ ] API访问权限控制机制有效
- [ ] 请求大小限制正常工作
- [ ] 安全日志记录完整
- [ ] 支持HTTPS访问配置

### NFR-004: 可维护性需求
**需求描述**: 系统应易于维护和扩展

**具体要求**:
- 代码结构清晰，模块化设计
- 提供完整的日志记录
- 支持配置热重载（开发环境）
- 提供系统状态监控接口
- 代码应有适当的注释和文档

**验收标准**:
- [ ] 代码模块化程度高
- [ ] 日志记录完整且有用
- [ ] 开发环境支持配置热重载
- [ ] 状态监控接口功能完整
- [ ] 代码注释和文档齐全

### NFR-005: 兼容性需求
**需求描述**: 系统应具备良好的兼容性

**具体要求**:
- 支持MCP协议标准规范
- 兼容主流操作系统（Windows、macOS、Linux）
- 支持Node.js 22+版本
- 兼容主流MCP服务器实现
- 支持标准HTTP客户端

**验收标准**:
- [ ] MCP协议兼容性测试通过
- [ ] 多操作系统测试通过
- [ ] Node.js版本兼容性验证
- [ ] 主流MCP服务器兼容性测试通过
- [ ] 各种HTTP客户端测试通过

## 技术需求

### TR-001: 技术栈要求
**开发环境**:
- Node.js 22+
- TypeScript 5.0+
- Express.js 4.x

**开发工具**:
- tsx: TypeScript执行器
- jest: 测试框架
- eslint: 代码检查
- prettier: 代码格式化

### TR-002: 架构设计要求
**系统架构**:
- 采用模块化设计
- 实现分层架构
- 支持插件化扩展
- 遵循SOLID原则

**核心模块**:
- MCP连接管理器
- HTTP服务器
- 请求路由器
- 配置管理器
- 日志系统

### TR-003: 接口设计要求
**HTTP API规范**:
- 遵循RESTful设计原则
- 支持JSON-RPC 2.0协议
- 提供标准的HTTP状态码
- 支持CORS跨域访问

**MCP协议兼容**:
- 完全兼容MCP协议规范
- 支持tools、resources、prompts三种功能
- 实现标准的错误处理机制

## 推荐架构设计

### 目录结构建议
```
mcps-proxy/
├── src/
│   ├── core/
│   │   ├── MCPConnectionManager.ts    # MCP连接管理器
│   │   ├── HTTPServer.ts              # 对外HTTP服务器
│   │   ├── RequestRouter.ts           # 请求路由器
│   │   ├── HTTPMCPClient.ts           # HTTP类型MCP服务器客户端
│   │   ├── StdioMCPServer.ts          # stdio类型MCP服务器
│   │   └── SSEMCPServer.ts            # SSE类型MCP服务器
│   ├── types/
│   │   ├── MCPTypes.ts                # MCP协议类型定义
│   │   └── ConfigTypes.ts             # 配置类型
│   ├── utils/
│   │   ├── Logger.ts                  # 日志工具
│   │   └── ConfigLoader.ts            # 配置加载器
│   ├── interfaces/
│   │   ├── IMCPServer.ts              # MCP服务器接口
│   │   └── IHTTPRouter.ts             # HTTP路由接口
│   └── app.ts                         # 应用入口
├── tests/
│   ├── unit/
│   └── integration/
├── docs/
│   └── api.md
├── schema/
│   └── config.schema.json             # 配置文件JSON Schema
└── package.json
```

### 核心模块设计

#### 1. MCPConnectionManager
```typescript
class MCPConnectionManager {
  private connections: Map<string, IMCPServer>;

  async addServer(config: ServerConfig): Promise<void>
  async removeServer(serverId: string): Promise<void>
  async listTools(): Promise<Tool[]>
  async callTool(toolName: string, args: any): Promise<any>
  async getResource(uri: string): Promise<any>
  getServerStatus(): ServerStatus[]
}
```

#### 2. RequestRouter
```typescript
class RequestRouter {
  async routeToolCall(request: ToolCallRequest): Promise<any>
  async routeResourceAccess(request: ResourceRequest): Promise<any>
  async routePrompt(request: PromptRequest): Promise<any>
  private resolveToolServer(toolName: string): string
}
```

#### 3. HTTPServer
```typescript
class HTTPServer {
  private express: Express;

  async start(port: number): Promise<void>
  setupRoutes(): void
}
```

## 接口设计需求

### API-001: HTTP API端点设计
**需求描述**: 系统应提供标准的HTTP API接口

**必需端点**:
- `POST /api/{schema}/mcp` - 统一的MCP协议端点
  - 支持tools/list操作
  - 支持tools/call操作
  - 支持resources/list操作
  - 支持resources/read操作
  - 支持prompts/list操作
  - 支持prompts/get操作
- `GET /api/status` - 系统状态查询端点

**协议要求**:
- 严格遵循JSON-RPC 2.0协议规范
- 提供标准的HTTP状态码
- 支持CORS跨域访问
- 返回格式统一化

### API-002: MCP协议兼容性
**需求描述**: 系统应完全兼容MCP协议规范

**兼容要求**:
- 支持MCP协议的所有核心功能
- 正确处理MCP协议的错误码
- 支持MCP协议的数据格式
- 实现MCP协议的通信机制

## 配置文件设计需求

### CFG-001: 配置文件结构
**需求描述**: 配置文件应支持灵活的MCP服务器配置

**配置位置**: `~/.mcps-proxy/config.json`

**必需配置项**:
- server: 服务器基本配置（端口、主机等）
- schemas: 多环境schema配置
- mcpServers: 每个schema下的MCP服务器列表
- enabled: schema级别的启用/禁用控制（可选，默认为true）

**配置格式要求**:
- 标准JSON格式
- 支持环境变量替换
- 支持多层级嵌套结构
- 提供配置验证机制
- 配置文件应包含 `$schema` 引用指向JSON Schema
- 每个schema可以包含enabled属性来控制是否启用

**配置验证要求**:
- 启动时必须验证配置文件格式
- 使用JSON Schema进行严格验证
- 配置错误时提供明确的错误信息
- 支持配置文件语法检查工具

### CFG-002: MCP服务器配置
**需求描述**: 应支持多种类型的MCP服务器配置

**服务器类型支持**:
- stdio类型：通过命令行启动的MCP服务器
- HTTP类型：通过HTTP协议访问的MCP服务器
- SSE类型：通过Server-Sent Events通信的MCP服务器

**配置参数要求**:
- stdio类型：command、args、env、cwd等
- HTTP类型：url、headers、timeout等
- SSE类型：url、headers、reconnectInterval、maxRetries等

## 部署需求

### DEP-001: 安装方式
**需求描述**: 系统应支持多种安装和部署方式

**安装要求**:
- 支持npm全局安装
- 支持npm本地安装
- 提供独立的可执行文件
- 支持Docker容器化部署

### DEP-002: 运行环境
**需求描述**: 系统应在主流环境中稳定运行

**环境要求**:
- 支持Windows、macOS、Linux操作系统
- 需要Node.js 22+运行环境
- 支持主流包管理器（npm、yarn、pnpm）

### DEP-003: 配置管理
**需求描述**: 系统应提供便捷的配置管理

**管理要求**:
- 首次运行自动创建默认配置
- 支持配置文件路径自定义
- 提供配置验证功能
- 支持配置热重载（开发环境）

## 验收测试需求

### TEST-001: 单元测试要求
**测试范围**:
- 核心模块功能测试
- 配置加载和验证测试
- 错误处理机制测试
- 工具调用路由测试

**覆盖率要求**:
- 代码覆盖率应达到80%以上
- 核心功能模块覆盖率应达到90%以上

### TEST-002: 集成测试要求
**测试场景**:
- 多种MCP服务器连接测试
- 并发请求处理测试
- 错误恢复测试
- 长时间运行稳定性测试

### TEST-003: API测试要求
**测试内容**:
- HTTP API端点功能测试
- JSON-RPC 2.0协议兼容性测试
- 错误响应格式测试
- 性能基准测试

## 文档需求

### DOC-001: 技术文档
**必需文档**:
- API接口文档
- 配置文件说明文档
- 架构设计文档
- 部署和运维文档

### DOC-002: 用户文档
**必需文档**:
- 快速入门指南
- 配置参考手册
- 故障排除指南
- 常见问题解答

## 项目交付要求

### DEL-001: 代码交付
**交付内容**:
- 完整的源代码
- 单元测试和集成测试
- 构建和部署脚本
- 配置文件模板

### DEL-002: 文档交付
**交付内容**:
- 完整的技术文档
- 用户使用指南
- API参考文档
- 开发者文档

### DEL-003: 工具交付
**交付内容**:
- 可执行的npm包
- Docker镜像（可选）
- 配置验证工具
- 示例配置文件

---

**文档版本**: 1.0
**最后更新**: 2025-10-19
**状态**: 需求规格说明完成
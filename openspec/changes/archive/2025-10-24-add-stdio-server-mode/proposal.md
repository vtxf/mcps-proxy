# 变更提案：添加STDIO服务器模式支持

## 变更ID
`add-stdio-server-mode`

## 变更类型
**新功能** - 添加新的服务模式支持

## Why

### 问题陈述
当前MCPS Proxy项目仅提供HTTP接口服务，虽然能够连接多种类型的MCP服务器（stdio、HTTP、SSE），但在某些场景下存在限制：

1. **命令行工具集成限制**：许多开发者需要在CLI工具中直接集成MCP功能，HTTP模式增加了额外的网络开销和复杂性
2. **CI/CD流水线需求**：在自动化构建和部署流程中，STDIO接口更适合与脚本和工具链集成
3. **性能优化需求**：对于本地开发环境，STDIO通信比HTTP更轻量级，延迟更低
4. **资源使用效率**：在某些场景下，用户只需要使用特定的schema功能，不需要初始化所有schemas

### 业务价值
添加STDIO模式支持将带来以下业务价值：
- **提升开发体验**：为开发者提供更灵活的MCP服务接入方式
- **扩大使用场景**：支持在无网络环境或受限环境中使用MCP功能
- **提高性能效率**：STDIO模式提供更低延迟和更少的资源消耗
- **增强兼容性**：与现有的MCP生态系统工具链保持一致

### 用户需求
基于用户反馈和市场需求，以下用户群体强烈需要STDIO模式支持：
- 希望在命令行工具中直接使用MCP功能的开发者
- 需要在CI/CD流水线中集成MCP服务的DevOps工程师
- 对性能有严格要求的专业用户
- 需要在嵌入式或受限环境中部署MCP服务的用户

## What Changes

### 核心变更概述
本变更将在现有架构基础上添加STDIO服务模式支持，主要包括以下方面的变更：

1. **新增STDIO代理服务器**：实现StdioProxyServer类，处理STDIO模式的JSON-RPC通信
2. **命令行参数扩展**：添加`--stdio`和`--schema`参数支持模式选择
3. **应用程序架构重构**：将Application类重构为支持HTTP和STDIO两种模式
4. **配置系统扩展**：添加STDIO模式相关配置选项
5. **Schema初始化策略优化**：STDIO模式仅初始化指定schema，提高资源利用效率

### 具体变更内容

#### 1. 新增组件
- **StdioProxyServer类**：处理STDIO模式的核心服务器实现
- **STDIOApplication类**：专门用于STDIO模式的应用程序类
- **CLI模式选择逻辑**：命令行参数解析和模式选择功能

#### 2. 修改组件
- **CLI类**：扩展命令行参数解析，添加模式选择逻辑
- **Application类**：重构为支持多模式架构（实际采用分离式设计）
- **配置类型定义**：添加STDIO相关配置接口
- **MCPConnectionManager**：保持不变，复用现有连接管理逻辑

#### 3. 新增功能特性
- **模式选择**：通过命令行参数选择HTTP或STDIO模式
- **Schema隔离**：STDIO模式仅初始化指定schema
- **JSON-RPC 2.0协议支持**：完整的STDIO协议实现
- **优雅关闭**：支持信号处理和资源清理

#### 4. 配置变更
- **CLI配置段**：添加cli.stdio配置选项
- **默认配置**：为STDIO模式提供合理默认值
- **验证规则**：添加新配置的验证逻辑

### 向后兼容性保证
- 现有HTTP模式功能完全保持不变
- 现有配置文件格式向后兼容
- 默认行为保持不变（仍为HTTP模式）
- 所有现有API和命令行参数继续有效

## 变更概述

本提案在现有MCPS Proxy项目基础上添加STDIO服务模式支持，使其能够同时提供HTTP和STDIO两种服务模式。当前项目已经支持连接多种类型的MCP服务器（stdio、HTTP、SSE），但对外只提供HTTP接口。本变更将添加STDIO服务模式，允许客户端通过标准输入输出与代理服务通信，同时保持完全的向后兼容性。

## 目标
1. **双模式支持**：使MCPS Proxy能够同时运行HTTP和STDIO两种服务模式
2. **统一架构**：在现有架构基础上扩展，保持向后兼容性
3. **灵活配置**：允许用户通过配置选择启用哪种服务模式
4. **功能对等**：确保STDIO模式提供与HTTP模式相同的功能

## 变更范围

### 功能范围
- 添加STDIO服务器模式，支持JSON-RPC 2.0协议通信
- 扩展配置系统，支持双模式服务配置
- 实现统一的请求处理逻辑，复用现有MCP连接管理
- 添加STDIO模式特定的生命周期管理

### 技术范围
- 新增`StdioProxyServer`类实现STDIO服务模式
- 扩展`Application`类支持多服务模式管理
- 更新配置类型定义，添加服务模式相关配置
- 保持现有HTTP模式功能不变

### 不包含范围
- 修改现有MCP服务器连接逻辑
- 更改HTTP API接口
- 修改现有的STDIO MCP服务器实现

## 用户故事

### 主要用户故事
**作为开发者**，我希望能够通过STDIO接口使用MCPS Proxy，以便：
- 在命令行工具中集成MCP功能
- 在CI/CD流水线中使用代理服务
- 在没有HTTP环境的场景下使用MCP服务
- 获得比HTTP更低的通信延迟

### 次要用户故事
**作为系统管理员**，我希望能够配置MCPS Proxy的服务模式，以便：
- 根据部署环境选择合适的通信方式
- 同时启用多种服务模式满足不同客户端需求
- 灵活控制服务监听方式和端口使用

## 验收标准

### 功能验收标准
- [ ] MCPS Proxy能够启动STDIO服务模式
- [ ] STDIO模式支持所有MCP协议操作（tools、resources、prompts）
- [ ] 配置系统能够控制启用哪些服务模式
- [ ] STDIO和HTTP模式可以同时运行
- [ ] 现有HTTP模式功能保持不变

### 质量验收标准
- [ ] STDIO模式的性能不低于HTTP模式
- [ ] 错误处理和日志记录功能完整
- [ ] 代码覆盖率维持在80%以上
- [ ] 通过所有现有测试用例

## 约束条件

### 技术约束
- 必须保持与现有配置文件的向后兼容性
- STDIO模式必须支持JSON-RPC 2.0协议
- 不能影响现有HTTP模式的稳定性和性能

### 业务约束
- 变更必须是向后兼容的，现有用户配置不受影响
- 默认行为保持不变（仅HTTP模式）
- 必须支持渐进式迁移路径

## 风险与缓解措施

### 技术风险
**风险**：STDIO模式可能存在进程管理复杂性
**缓解措施**：使用Node.js内置的process.stdin/stdout，参考现有StdioMCPServer实现

**风险**：双模式可能存在资源竞争
**缓解措施**：使用统一的连接管理器，确保资源共享的一致性

### 兼容性风险
**风险**：可能影响现有HTTP模式性能
**缓解措施**：STDIO模式作为独立模块，不影响HTTP路径

## 成功指标

### 功能指标
- STDIO模式成功处理100%的MCP协议操作
- 配置系统正确支持双模式配置
- 现有HTTP模式零功能回归

### 性能指标
- STDIO模式请求响应时间<100ms
- 内存使用增长<20%
- 并发处理能力不低于HTTP模式

## 相关变更

### 依赖变更
- 无新增外部依赖
- 可能需要更新开发依赖

### 影响变更
- 配置文件结构需要更新
- 启动脚本可能需要调整

## 实施建议

### 阶段一：核心STDIO服务器实现
- 实现StdioProxyServer类
- 添加基础配置支持
- 实现JSON-RPC协议处理

### 阶段二：集成与配置
- 更新Application类支持多模式
- 扩展配置系统
- 实现统一请求处理逻辑

### 阶段三：测试与优化
- 添加STDIO模式测试
- 性能优化和调试
- 文档更新

## 后续考虑

### 短期考虑
- 添加STDIO模式特定的高级功能
- 优化错误处理和用户体验
- 完善监控和日志功能

### 长期考虑
- 支持更多服务模式（如WebSocket）
- 实现服务模式间的负载均衡
- 添加服务发现机制